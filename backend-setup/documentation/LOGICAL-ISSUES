



QUESTION 


I HAVE A GENUINE DOUBT, IF A USER GET INTO THE MOVIE BOOKING AND HE RESERVED THE SEAT,
 AND THE MOMENT WE TURN ON INNGEST FOR AUTO DELETION FOR THAT BOOKINGID ,   
 AND USER REMAIN ON THE PAYMENT PAGE WITHOUT PAYING, THEN AFTER 10 MINUTE , 
 THE BOOKING ID DOCUMENT WILL BE DELETED AND SEAT WILL BE RELIVED BUT STILL 
 THE USER ON THE PAYMENT PAGE STRIPE . SO ON THE 11TH MINUTE , IF HE TRY TO MAKE
  THE PAYMENT THE PAYMENT WILL DONE BUT NO BOOKING ID OR DOCUMENT, WILL REMAIN . SO HOW TO SOLVE
   THIS ISSUE?  BY MAKING THE EXPIRY TIME OF STRIPE EXACTLY AS OF DELETING DOCUMENT? 10 MINUTE?
    CURRENCTLY STRIPE PAYMENT TIME IS 30 MINUTE FOR EXPIRY SO SHOULD I MAKE IT TO 10 MINUTE
     FOR STIPE ?

Excellent Question! This is a Real Problem! üö®
You've identified a critical race condition:





1) Timeline: 
0:00  ‚Üí User books seats
0:01  ‚Üí Stripe checkout created (expires in 30 min)
0:01  ‚Üí Inngest function scheduled (deletes in 10 min)
10:00 ‚Üí Inngest deletes booking + releases seats ‚ùå
11:00 ‚Üí User pays on Stripe ‚úÖ
       ‚Üí Payment succeeds but no booking exists! üí•



 ///issue again stripe needed 30 minute minimum epxiration timing 

 IF booking.status === "EXPIRED"
  ‚Üí REFUND immediately
  ‚Üí log late payment
ELSE
  ‚Üí confirm booking
  ‚Üí status = "CONFIRMED"



User stays on Stripe page
Booking expires at 10 min
User pays at 11 min

‚úÖ What SHOULD happen
 IF USER DO THE PAYMENT AFTER BOOKING EXPIRED, WE WILL INITIATE A REFUND FROM THE STRIPE WEBHOOK SPOTLY 
 AND A MESSAGE WILL BE SHOWN THAT 1-5 DAYS THE FUND WILL BE REFUNDED 






 //ISSUE-2 

 08:00 ‚Üí Cron runs, checks shows from 08:00-16:00
09:00 ‚Üí User books ticket for 12:00 show
10:00 ‚Üí User should get reminder (2 hours before 12:00)
        ‚ùå But cron won't run again until 16:00!
16:00 ‚Üí Next cron runs (too late, show already happened at 12:00)




SOLUTION 


The Correct Solution: Schedule Per-Booking Reminders
You need to schedule individual reminders when the booking is confirmed, not use a batch cron job.




  // ============================================================
  // ‚úÖ SCHEDULE REMINDER EMAIL - 2 HOURS BEFORE SHOW
  // ============================================================
  
  try {
    const showTime = new Date(booking.show.showDateTime);
    const reminderTime = new Date(showTime.getTime() - 2 * 60 * 60 * 1000); // 2 hours before
    const now = new Date();

    // Only schedule if show is more than 2 hours away
    if (reminderTime > now) {
      console.log(`üìÖ Scheduling reminder for ${reminderTime.toISOString()}`);
      
      await inngest.send({
        name: "app.scheduleShowReminder",
        data: {
          bookingId: booking._id.toString(),
          userId: userId,
          scheduledFor: reminderTime.toISOString(),
        },
      });
      
      console.log("‚úÖ Reminder scheduled successfully");
    } else {
      console.log("‚ö†Ô∏è Show is less than 2 hours away, skipping reminder");
    }
  } catch (reminderError) {
    console.error("‚ùå Failed to schedule reminder:", reminderError);
    // Don't fail the webhook - booking is still confirmed
  }
