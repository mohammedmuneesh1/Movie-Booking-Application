



QUESTION 


I HAVE A GENUINE DOUBT, IF A USER GET INTO THE MOVIE BOOKING AND HE RESERVED THE SEAT,
 AND THE MOMENT WE TURN ON INNGEST FOR AUTO DELETION FOR THAT BOOKINGID ,   
 AND USER REMAIN ON THE PAYMENT PAGE WITHOUT PAYING, THEN AFTER 10 MINUTE , 
 THE BOOKING ID DOCUMENT WILL BE DELETED AND SEAT WILL BE RELIVED BUT STILL 
 THE USER ON THE PAYMENT PAGE STRIPE . SO ON THE 11TH MINUTE , IF HE TRY TO MAKE
  THE PAYMENT THE PAYMENT WILL DONE BUT NO BOOKING ID OR DOCUMENT, WILL REMAIN . SO HOW TO SOLVE
   THIS ISSUE?  BY MAKING THE EXPIRY TIME OF STRIPE EXACTLY AS OF DELETING DOCUMENT? 10 MINUTE?
    CURRENCTLY STRIPE PAYMENT TIME IS 30 MINUTE FOR EXPIRY SO SHOULD I MAKE IT TO 10 MINUTE
     FOR STIPE ?

Excellent Question! This is a Real Problem! üö®
You've identified a critical race condition:





1) Timeline: 
0:00  ‚Üí User books seats
0:01  ‚Üí Stripe checkout created (expires in 30 min)
0:01  ‚Üí Inngest function scheduled (deletes in 10 min)
10:00 ‚Üí Inngest deletes booking + releases seats ‚ùå
11:00 ‚Üí User pays on Stripe ‚úÖ
       ‚Üí Payment succeeds but no booking exists! üí•



 ///issue again stripe needed 30 minute minimum epxiration timing 

 IF booking.status === "EXPIRED"
  ‚Üí REFUND immediately
  ‚Üí log late payment
ELSE
  ‚Üí confirm booking
  ‚Üí status = "CONFIRMED"



User stays on Stripe page
Booking expires at 10 min
User pays at 11 min

‚úÖ What SHOULD happen

Payment succeeds (Stripe allows it)
Webhook fires
Backend sees:
booking.status === "EXPIRED"
You refund automatically
Show user:
‚ÄúPayment received too late. Seats were released. Amount refunded.‚Äù




SOLUTIOHN 

Option 1: Make Stripe Expire at Same Time as Inngest (Recommended) ‚úÖ


MAKE THE STRIPE EXPIRY 10 MINUTE , SAME TIME MAKE INGEST EXPIRY 10 MINUTES 



booking schema 



    status: {
      type: String,
      enum: ["PENDING_PAYMENT", "CONFIRMED", "EXPIRED", "CANCELLED"],
      default: "PENDING_PAYMENT",
    },

    expiresAt: {
      type: Date,
      required: true,
    },



the logic working on webhook 


if expired , then iniate spot refunt 





 //IF NOT BOOKING FOUND , DONT TRIGGER REFUND INSTEAD WAIT FOR USER TO APPRAOCH YOU  AND CHECK STRIPE RAW EVENT ON PAYMENT MODEL TO RECLAIM REFUND(DO THE REFUND MANUALLY )


                  //IF PAYMENT IS EXPIRED , THEN SEND BACK THE PAYMENT REFUND START





                if (booking.status === "EXPIRED" || booking.status === "CANCELLED") {


     // ‚úÖ Legit late payment ‚Üí refund
    await stripeInstance.refunds.create({
      payment_intent: session?.payment_intent as string,
    });



    await PaymentModel.findOneAndUpdate(
      { paymentCustomUniqueId },
      {
        status: "refunded",
        isPaid: false,
        paymentIntentId: session?.payment_intent,
      }
    );

    return ResponseHandler(response,200,false,null,'Booking Expired. Payment Refunded.');
           }
                //IF PAYMENT IS EXPIRED , THEN SEND BACK THE PAYMENT REFUND START
                const payment = await PaymentModel.findOneAndUpdate(
                    {
                    paymentCustomUniqueId:paymentCustomUniqueId,
                    userId:userId,
                },
                { 
                    status: "succeeded",
                    isPaid: true,
                      paymentIntentId:session?.payment_intent as string, 
                },{
                    new:true,
                }
                );
                break;
            }
    
             default:
                console.log(`Unhandled event type ${event.type}`);
                break;    
        }
        return ResponseHandler(response,200,true,{received:true},'stripe webhook success');
    } catch (error) {
        console.error('`Webhook processing error:',error);
        return ResponseHandler(response,200,false,null,'stripe webhook processing error');
    }
}


